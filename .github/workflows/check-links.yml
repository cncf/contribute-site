# This workflow checks for broken links in the built site using htmltest
#
# Features:
# - Runs weekly every Monday at 9:00 UTC
# - Can be manually triggered
# - Uses htmltest from @chalin's maintained fork with latest updates
# - Creates/updates GitHub issues when broken links are found
# - Automatically closes issues when all links are fixed
# - Uploads detailed results as artifacts for review
#
# Configuration:
# - Uses .htmltest.yml for skip patterns and other settings
# - Uses Makefile (aligned with @cncf/techdocs) for build orchestration
# - Builds htmltest from source using Go for latest updates
# - Skips social media links to avoid rate limiting
# - Maintains a reference cache to speed up checks

name: Check Links on Live Site

on:
  schedule:
    # Run every Monday at 9:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  check-links:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: 'npm'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Install htmltest
        run: |
          HTMLTEST_REPO=github.com/chalin/htmltest
          BRANCH=dev/main
          REPO_DIR=tmp/htmltest
          git clone --branch $BRANCH https://$HTMLTEST_REPO.git $REPO_DIR
          pushd $REPO_DIR
          make build
          popd
          HTMLTEST=$REPO_DIR/bin/htmltest
          echo "HTMLTEST=$HTMLTEST" >> $GITHUB_ENV

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: npm run build

      - name: Check links with htmltest
        id: htmltest
        continue-on-error: true
        run: |
          echo "Running link check with htmltest..."
          npm run check:links 2>&1 | tee htmltest-output.txt
          exit ${PIPESTATUS[0]}

      - name: Process and analyze results
        id: analyze
        if: always()
        run: |
          node .github/scripts/analyze-htmltest.js > link-analysis.md || true
          cat link-analysis.md

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: link-check-results
          path: |
            htmltest-output.txt
            link-analysis.md
            tmp/.htmltest/
          retention-days: 30

      - name: Create or update issue on failure
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let analysis = 'Link check failed. See workflow run for details.';

            try {
              analysis = fs.readFileSync('link-analysis.md', 'utf8');
            } catch (error) {
              console.log('Could not read analysis file:', error.message);
            }

            const dateStr = new Date().toISOString().split('T')[0];
            const title = 'Broken links detected on site (' + dateStr + ')';
            const runUrl = 'https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId;

            const body = '# Broken Links Detected\n\n' +
              'This issue was automatically created because the weekly link check found broken links.\n\n' +
              analysis + '\n\n' +
              '## Actions Required\n\n' +
              '1. Review the broken links listed above\n' +
              '2. Update or remove the broken links in the source files\n' +
              '3. Test locally with `npm run check:links`\n' +
              '4. Close this issue once all broken links are addressed\n\n' +
              '## Workflow Run\n\n' +
              'See the [workflow run](' + runUrl + ') for detailed logs and downloadable results.\n\n' +
              '---\n' +
              '*This issue was automatically created by the [Check Links workflow](.github/workflows/check-links.yml)*';

            // Check if a similar issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'broken-links'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('Broken links detected on site')
            );

            if (existingIssue) {
              // Update existing issue with new comment
              const commentBody = '## Updated Link Check Results (' + dateStr + ')\n\n' +
                analysis + '\n\n' +
                'See the [latest workflow run](' + runUrl + ') for details.';

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: commentBody
              });

              console.log('Updated existing issue #' + existingIssue.number);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['broken-links', 'maintenance']
              });

              console.log('Created new issue #' + issue.data.number);
            }

      - name: Close issue on success
        if: success() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            // Close any open broken-links issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'broken-links'
            });

            const runUrl = 'https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId;

            for (const issue of issues.data) {
              if (issue.title.includes('Broken links detected on site')) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: 'âœ… All broken links have been fixed! No broken links detected in the [latest check](' + runUrl + ').'
                });

                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed'
                });

                console.log('Closed issue #' + issue.number);
              }
            }
